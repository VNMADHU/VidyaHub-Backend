// This is your Prisma schema file.
// Learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id       Int     @id @default(autoincrement())
  email    String  @unique
  password String
  role     String  // super-admin, school-admin, teacher, student, parent
  schoolId Int?
  school   School? @relation(fields: [schoolId], references: [id])
  profile  Profile?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Profile {
  id        Int     @id @default(autoincrement())
  userId    Int     @unique
  user      User    @relation(fields: [userId], references: [id])
  firstName String
  lastName  String
  phone     String?
  avatar    String?
}

model School {
  id           Int     @id @default(autoincrement())
  name         String
  address      String
  contact      String
  principal    String
  boardType    String  // CBSE, ICSE, State, University
  schoolCode   String?  // Affiliation/DISE code
  academicYear String?  @default("2025-26")
  logo         String?
  status       String  @default("pending") // pending, active, blocked
  users        User[]
  students     Student[]
  teachers     Teacher[]
  classes      Class[]
  events       Event[]
  announcements Announcement[]
  sports       Sport[]
  fees         Fee[]
  homework     Homework[]
  periods      Period[]
  notifications Notification[]
  books         Book[]
  vehicles      Vehicle[]
  drivers       Driver[]
  expenses      Expense[]
  supportTickets SupportTicket[]
  leaves        Leave[]
  holidays      Holiday[]
  staff         Staff[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Student {
  id          Int     @id @default(autoincrement())
  schoolId    Int
  school      School  @relation(fields: [schoolId], references: [id])
  firstName   String
  lastName    String
  email       String
  dateOfBirth DateTime?
  gender      String?
  admissionNumber String
  rollNumber  String?
  profilePic  String?
  classId     Int?
  class       Class?  @relation(fields: [classId], references: [id])
  sectionId   Int?
  section     Section? @relation(fields: [sectionId], references: [id])
  // Indian school specific fields
  aadhaarNumber String?   // 12-digit Aadhaar (RTE compliance)
  bloodGroup    String?   // A+, A-, B+, B-, AB+, AB-, O+, O-
  category      String?   // General, OBC, SC, ST, EWS
  religion      String?
  nationality   String?   @default("Indian")
  address       String?   // Current address
  permanentAddress String? // Permanent address
  transportMode String?   // School bus, Auto, Walk, Private
  busRoute      String?   // Bus route number/name
  previousSchool String?  // For transfer students
  tcNumber      String?   // Transfer Certificate number
  // Parent/Guardian details
  fatherName  String?
  motherName  String?
  guardianName String?
  fatherContact String?
  motherContact String?
  guardianContact String?
  parentEmail String?
  attendance  Attendance[]
  marks       Mark[]
  achievements Achievement[]
  fees        Fee[]
  bookIssues  BookIssue[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([schoolId, admissionNumber])
  @@unique([schoolId, rollNumber])
}

model Teacher {
  id            Int     @id @default(autoincrement())
  schoolId      Int
  school        School  @relation(fields: [schoolId], references: [id])
  firstName     String
  lastName      String
  email         String  @unique
  dateOfBirth   DateTime?
  phoneNumber   String?
  subject       String?
  qualification String?
  experience    String?
  teacherId     String?  @unique
  profilePic    String?
  // Indian school specific fields
  designation   String?  // PRT, TGT, PGT, HOD, Vice Principal, Principal
  department    String?  // Science, Commerce, Arts, etc.
  joiningDate   DateTime?
  address       String?
  aadhaarNumber String?  // 12-digit Aadhaar
  panNumber     String?  // PAN card
  gender        String?  // male, female, other
  bloodGroup    String?  // A+, A-, B+, B-, AB+, AB-, O+, O-
  classes       Class[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Class {
  id         Int     @id @default(autoincrement())
  schoolId   Int
  school     School  @relation(fields: [schoolId], references: [id])
  name       String  // e.g., "10-A"
  sections   Section[]
  students   Student[]
  teachers   Teacher[]
  timetables Timetable[]
  exams      Exam[]
  homework   Homework[]
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([schoolId, name])
}

model Section {
  id        Int     @id @default(autoincrement())
  classId   Int
  class     Class   @relation(fields: [classId], references: [id])
  name      String  // e.g., "A", "B"
  students  Student[]
  exams     Exam[]
  homework  Homework[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([classId, name])
}

model Subject {
  id    Int    @id @default(autoincrement())
  name  String @unique
  code  String @unique
}

model Attendance {
  id        Int     @id @default(autoincrement())
  studentId Int
  student   Student @relation(fields: [studentId], references: [id])
  date      DateTime
  status    String  // present, absent, late
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId, date])
}

model Exam {
  id        Int     @id @default(autoincrement())
  name      String  // Unit Test, Midterm, Final
  classId   Int?
  class     Class?  @relation(fields: [classId], references: [id])
  sectionId Int?
  section   Section? @relation(fields: [sectionId], references: [id])
  marks     Mark[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Mark {
  id        Int     @id @default(autoincrement())
  studentId Int
  student   Student @relation(fields: [studentId], references: [id])
  examId    Int
  exam      Exam    @relation(fields: [examId], references: [id])
  subject   String
  score     Float
  maxScore  Float   @default(100)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId, examId, subject])
}

model Event {
  id          Int     @id @default(autoincrement())
  schoolId    Int
  school      School  @relation(fields: [schoolId], references: [id])
  title       String
  date        DateTime
  description String
  location    String?  // Where the event takes place
  category    String?  @default("academic") // academic, sports, cultural, other
  images      String? // comma-separated URLs
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Announcement {
  id        Int     @id @default(autoincrement())
  schoolId  Int
  school    School  @relation(fields: [schoolId], references: [id])
  title     String
  message   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Achievement {
  id                Int     @id @default(autoincrement())
  studentId         Int
  student           Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  title             String
  category          String  @default("other")
  achievementDate   DateTime
  description       String
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model Sport {
  id          Int     @id @default(autoincrement())
  schoolId    Int
  school      School  @relation(fields: [schoolId], references: [id])
  name        String
  coachName   String
  schedule    String
  description String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Fee {
  id          Int      @id @default(autoincrement())
  schoolId    Int
  school      School   @relation(fields: [schoolId], references: [id])
  studentId   Int
  student     Student  @relation(fields: [studentId], references: [id])
  feeType     String   // tuition, exam, transport, library, sports, lab, other
  description String?
  amount      Float
  dueDate     DateTime
  status      String   @default("pending") // pending, paid, overdue, partial
  paidAmount  Float    @default(0)
  paidDate    DateTime?
  paymentMode String?  // cash, online, cheque, upi
  transactionId String?
  academicYear String?  // e.g., "2025-2026"
  term        String?  // e.g., "Term 1", "Term 2", "Annual"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Period {
  id         Int     @id @default(autoincrement())
  schoolId   Int
  school     School  @relation(fields: [schoolId], references: [id])
  name       String  // e.g. "Period 1", "Lunch", "Zero Period"
  startTime  String  // e.g. "08:00"
  endTime    String  // e.g. "08:45"
  sortOrder  Int     @default(0)
  isBreak    Boolean @default(false) // Lunch, recess, etc.
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([schoolId, name])
  @@unique([schoolId, sortOrder])
}

model Timetable {
  id            Int      @id @default(autoincrement())
  classId       Int
  class         Class    @relation(fields: [classId], references: [id])
  day           String   // Monday, Tuesday, etc
  periodId      Int      @default(0) // References Period
  subject       String
  teacher       String
  effectiveFrom DateTime @default(now()) // Date from which this timetable is effective
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Homework {
  id          Int       @id @default(autoincrement())
  schoolId    Int
  school      School    @relation(fields: [schoolId], references: [id])
  classId     Int
  class       Class     @relation(fields: [classId], references: [id])
  sectionId   Int?
  section     Section?  @relation(fields: [sectionId], references: [id])
  subject     String
  title       String
  description String    @default("")
  dueDate     DateTime
  assignedBy  String    @default("")  // Teacher name
  status      String    @default("active") // active, completed, cancelled
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Notification {
  id          Int      @id @default(autoincrement())
  schoolId    Int
  school      School   @relation(fields: [schoolId], references: [id])
  type        String   // announcement, event, report, fee-reminder, homework, custom
  channel     String   // email, sms, both
  subject     String
  message     String
  audience    String   // all-parents, class:<id>, student:<id>, custom
  sentBy      String   // email of admin who triggered
  totalSent   Int      @default(0)
  totalFailed Int      @default(0)
  status      String   @default("sent") // sent, partial, failed
  errors      String?  // JSON array of error strings
  createdAt   DateTime @default(now())
}

// ── Library Management ────────────────────────────────────
model Book {
  id            Int        @id @default(autoincrement())
  schoolId      Int
  school        School     @relation(fields: [schoolId], references: [id])
  title         String
  author        String
  isbn          String?
  category      String?    // fiction, non-fiction, textbook, reference, magazine
  publisher     String?
  edition       String?
  language      String?    @default("English")
  totalCopies   Int        @default(1)
  availableCopies Int      @default(1)
  shelfLocation String?    // e.g., "Rack A-3"
  status        String     @default("available") // available, all-issued, damaged, lost
  issues        BookIssue[]
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  @@unique([schoolId, isbn])
}

model BookIssue {
  id          Int       @id @default(autoincrement())
  bookId      Int
  book        Book      @relation(fields: [bookId], references: [id], onDelete: Cascade)
  studentId   Int
  student     Student   @relation(fields: [studentId], references: [id])
  issueDate   DateTime  @default(now())
  dueDate     DateTime
  returnDate  DateTime?
  status      String    @default("issued") // issued, returned, overdue, lost
  fine        Float     @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// ── Transport Management ──────────────────────────────────
model Vehicle {
  id              Int      @id @default(autoincrement())
  schoolId        Int
  school          School   @relation(fields: [schoolId], references: [id])
  vehicleNumber   String   // e.g., "AP 07 AB 1234"
  vehicleType     String   // bus, van, auto, car
  capacity        Int
  driverId        Int?
  driver          Driver?  @relation(fields: [driverId], references: [id])
  routeName       String?  // e.g., "Route 1 - Kukatpally to School"
  routeStops      String?  // comma-separated stop names
  insuranceExpiry DateTime?
  fitnessExpiry   DateTime?
  permitExpiry    DateTime?
  status          String   @default("active") // active, maintenance, inactive
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([schoolId, vehicleNumber])
}

model Driver {
  id                Int       @id @default(autoincrement())
  schoolId          Int
  school            School    @relation(fields: [schoolId], references: [id])
  firstName         String
  lastName          String
  phoneNumber       String
  dateOfBirth       DateTime?
  address           String?
  experience        String?   // years of driving experience
  // Indian driving documents
  licenseNumber     String    // DL number e.g., "AP-0620170012345"
  licenseType       String?   // LMV, HMV, HTV, HGMV, etc.
  licenseExpiry     DateTime?
  aadhaarNumber     String?   // 12-digit Aadhaar
  badgeNumber       String?   // Conductor/Driver badge from RTO
  bloodGroup        String?
  emergencyContact  String?
  profilePic        String?
  status            String    @default("active") // active, on-leave, inactive
  vehicles          Vehicle[]
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

// ── Non-Teaching Staff ────────────────────────────────────
model Staff {
  id               Int       @id @default(autoincrement())
  schoolId         Int
  school           School    @relation(fields: [schoolId], references: [id])
  firstName        String
  lastName         String
  staffId          String?   // e.g., STF001
  designation      String    // Watchman, Cleaner, Peon, Accountant, Lab Assistant, etc.
  department       String?   // Office, Lab, Security, Kitchen, etc.
  phoneNumber      String?
  email            String?
  dateOfBirth      DateTime?
  gender           String?
  address          String?
  aadhaarNumber    String?
  joiningDate      DateTime?
  salary           Float?
  bloodGroup       String?
  emergencyContact String?
  profilePic       String?
  status           String    @default("active") // active, on-leave, inactive, terminated
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
}

// ── Expense Tracking ──────────────────────────────────────
model Expense {
  id          Int      @id @default(autoincrement())
  schoolId    Int
  school      School   @relation(fields: [schoolId], references: [id])
  title       String
  category    String   // maintenance, salary, supplies, transport, utility, infrastructure, events, other
  amount      Float
  date        DateTime
  paidTo      String?  // vendor / person name
  paymentMode String?  // cash, online, cheque, upi
  receiptNo   String?
  description String?
  approvedBy  String?  // admin name/email
  status      String   @default("approved") // pending, approved, rejected
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
// ── Leave Management ─────────────────────────────────────────
model Leave {
  id            Int      @id @default(autoincrement())
  schoolId      Int
  school        School   @relation(fields: [schoolId], references: [id])
  employeeType  String   // teacher, driver, staff
  employeeId    Int?     // optional FK reference
  employeeName  String
  leaveType     String   // sick, casual, annual, maternity, paternity, emergency, unpaid
  fromDate      DateTime
  toDate        DateTime
  days          Int
  reason        String
  status        String   @default("pending") // pending, approved, rejected
  approvedBy    String?
  remarks       String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// ── Holiday Management ────────────────────────────────────────
model Holiday {
  id          Int      @id @default(autoincrement())
  schoolId    Int
  school      School   @relation(fields: [schoolId], references: [id])
  title       String
  date        DateTime
  toDate      DateTime?
  type        String   @default("national") // national, regional, school, religious, seasonal
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
// ── Support Tickets ───────────────────────────────────────
model SupportTicket {
  id          Int      @id @default(autoincrement())
  schoolId    Int
  school      School   @relation(fields: [schoolId], references: [id])
  subject     String
  message     String
  category    String   @default("general") // general, bug, feature-request, billing, other
  priority    String   @default("medium")  // low, medium, high, urgent
  status      String   @default("open")    // open, in-progress, resolved, closed
  reply       String?  // admin reply
  repliedAt   DateTime?
  createdBy   String   // email of the user who created
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
