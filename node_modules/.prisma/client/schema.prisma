// This is your Prisma schema file.
// Learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  role      String // super-admin, school-admin, teacher, student, parent
  schoolId  Int?
  school    School?  @relation(fields: [schoolId], references: [id])
  profile   Profile?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Profile {
  id        Int     @id @default(autoincrement())
  userId    Int     @unique
  user      User    @relation(fields: [userId], references: [id])
  firstName String
  lastName  String
  phone     String?
  avatar    String?
}

model School {
  id            Int            @id @default(autoincrement())
  name          String
  address       String
  contact       String
  principal     String
  boardType     String // CBSE, ICSE, State, University
  logo          String?
  status        String         @default("pending") // pending, active, blocked
  users         User[]
  students      Student[]
  teachers      Teacher[]
  classes       Class[]
  events        Event[]
  announcements Announcement[]
  sports        Sport[]
  fees          Fee[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

model Student {
  id              Int           @id @default(autoincrement())
  schoolId        Int
  school          School        @relation(fields: [schoolId], references: [id])
  firstName       String
  lastName        String
  email           String
  dateOfBirth     DateTime?
  gender          String?
  admissionNumber String
  rollNumber      String?
  profilePic      String?
  classId         Int?
  class           Class?        @relation(fields: [classId], references: [id])
  sectionId       Int?
  section         Section?      @relation(fields: [sectionId], references: [id])
  fatherName      String?
  motherName      String?
  guardianName    String?
  fatherContact   String?
  motherContact   String?
  guardianContact String?
  parentEmail     String?
  attendance      Attendance[]
  marks           Mark[]
  achievements    Achievement[]
  fees            Fee[]
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@unique([schoolId, admissionNumber])
  @@unique([schoolId, rollNumber])
}

model Teacher {
  id            Int      @id @default(autoincrement())
  schoolId      Int
  school        School   @relation(fields: [schoolId], references: [id])
  firstName     String
  lastName      String
  email         String   @unique
  phoneNumber   String?
  subject       String?
  qualification String?
  experience    String?
  teacherId     String?  @unique
  profilePic    String?
  classes       Class[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Class {
  id         Int         @id @default(autoincrement())
  schoolId   Int
  school     School      @relation(fields: [schoolId], references: [id])
  name       String // e.g., "10-A"
  sections   Section[]
  students   Student[]
  teachers   Teacher[]
  timetables Timetable[]
  exams      Exam[]
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  @@unique([schoolId, name])
}

model Section {
  id        Int       @id @default(autoincrement())
  classId   Int
  class     Class     @relation(fields: [classId], references: [id])
  name      String // e.g., "A", "B"
  students  Student[]
  exams     Exam[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([classId, name])
}

model Subject {
  id   Int    @id @default(autoincrement())
  name String @unique
  code String @unique
}

model Attendance {
  id        Int      @id @default(autoincrement())
  studentId Int
  student   Student  @relation(fields: [studentId], references: [id])
  date      DateTime
  status    String // present, absent
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId, date])
}

model Exam {
  id        Int      @id @default(autoincrement())
  name      String // Unit Test, Midterm, Final
  classId   Int?
  class     Class?   @relation(fields: [classId], references: [id])
  sectionId Int?
  section   Section? @relation(fields: [sectionId], references: [id])
  marks     Mark[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Mark {
  id        Int      @id @default(autoincrement())
  studentId Int
  student   Student  @relation(fields: [studentId], references: [id])
  examId    Int
  exam      Exam     @relation(fields: [examId], references: [id])
  subject   String
  score     Float
  maxScore  Float    @default(100)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId, examId, subject])
}

model Event {
  id          Int      @id @default(autoincrement())
  schoolId    Int
  school      School   @relation(fields: [schoolId], references: [id])
  title       String
  date        DateTime
  description String
  images      String? // comma-separated URLs
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Announcement {
  id        Int      @id @default(autoincrement())
  schoolId  Int
  school    School   @relation(fields: [schoolId], references: [id])
  title     String
  message   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Achievement {
  id              Int      @id @default(autoincrement())
  studentId       Int
  student         Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  title           String
  category        String   @default("other")
  achievementDate DateTime
  description     String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Sport {
  id          Int      @id @default(autoincrement())
  schoolId    Int
  school      School   @relation(fields: [schoolId], references: [id])
  name        String
  coachName   String
  schedule    String
  description String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Fee {
  id            Int       @id @default(autoincrement())
  schoolId      Int
  school        School    @relation(fields: [schoolId], references: [id])
  studentId     Int
  student       Student   @relation(fields: [studentId], references: [id])
  feeType       String // tuition, exam, transport, library, sports, lab, other
  description   String?
  amount        Float
  dueDate       DateTime
  status        String    @default("pending") // pending, paid, overdue, partial
  paidAmount    Float     @default(0)
  paidDate      DateTime?
  paymentMode   String? // cash, online, cheque, upi
  transactionId String?
  academicYear  String? // e.g., "2025-2026"
  term          String? // e.g., "Term 1", "Term 2", "Annual"
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Timetable {
  id        Int      @id @default(autoincrement())
  classId   Int
  class     Class    @relation(fields: [classId], references: [id])
  day       String // Monday, Tuesday, etc
  period    Int
  subject   String
  teacher   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
